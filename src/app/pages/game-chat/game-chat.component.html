<div class="game-chat-container">
  <!-- Header with Title and Home Button -->
  <div class="game-header">
    <div class="d-flex justify-content-between align-items-center">
      <h1 class="game-title mb-0">
        <i class="bi bi-tower"></i> Magic Tower - KI Adventure
      </h1>
      <button class="btn btn-outline-light" routerLink="/home">
        <i class="bi bi-house-door"></i> Zur√ºck zum Startbildschirm
      </button>
    </div>
  </div>

  <!-- Battle Status Row - Character vs Enemy -->
  <div class="battle-status-row" *ngIf="gameState">
    <div class="row g-3">
      <!-- Character Status -->
      <div class="col-md-6">
        <div class="status-card character-card">
          <div class="status-header">
            <h3 class="mb-1">
              {{ gameState.character.name }}
              <span class="badge bg-primary ms-2">{{ gameState.character.className }}</span>
            </h3>
            <span class="level-badge">Level {{ gameState.character.level }}</span>
          </div>
          
          <div class="status-body">
            <div class="stat-row">
              <span class="stat-label">
                <i class="bi bi-heart-fill text-danger"></i> Gesundheit:
              </span>
              <div class="health-bar-container">
                <div 
                  class="health-bar" 
                  [class]="getHealthBarClass(gameState.character.currentHealth, gameState.character.maxHealth)"
                  [style.width.%]="getHealthPercentage(gameState.character.currentHealth, gameState.character.maxHealth)">
                </div>
                <span class="health-text">
                  {{ gameState.character.currentHealth }} / {{ gameState.character.maxHealth }}
                </span>
              </div>
            </div>

            <div class="stat-row">
              <span class="stat-label">
                <i class="bi bi-lightning-fill text-warning"></i> Angriffskraft:
              </span>
              <span class="stat-value">{{ gameState.character.totalAttackPower }}</span>
            </div>

            <div class="stat-row">
              <span class="stat-label">
                <i class="bi bi-star-fill text-info"></i> Spezialangriff:
              </span>
              <span class="stat-value">Level {{ gameState.character.specialAttackLevel }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Enemy Status -->
      <div class="col-md-6">
        <div class="status-card enemy-card">
          <div class="status-header">
            <h3 class="mb-1">
              {{ gameState.currentEnemy?.displayName || gameState.currentEnemy?.race + ' ' + gameState.currentEnemy?.type }}
              <span class="badge bg-danger ms-2" *ngIf="gameState.currentEnemy?.isBoss">BOSS</span>
            </h3>
            <span class="level-badge">Level {{ gameState.currentEnemy?.level }}</span>
          </div>
          
          <div class="status-body" *ngIf="gameState.currentEnemy">
            <div class="stat-row">
              <span class="stat-label">
                <i class="bi bi-heart-fill text-danger"></i> Gesundheit:
              </span>
              <div class="health-bar-container">
                <div 
                  class="health-bar" 
                  [class]="getHealthBarClass(gameState.currentEnemy.health, gameState.currentEnemy.maxHealth)"
                  [style.width.%]="getHealthPercentage(gameState.currentEnemy.health, gameState.currentEnemy.maxHealth)">
                </div>
                <span class="health-text">
                  {{ gameState.currentEnemy.health }} / {{ gameState.currentEnemy.maxHealth }}
                </span>
              </div>
            </div>

            <div class="stat-row">
              <span class="stat-label">
                <i class="bi bi-lightning-fill text-warning"></i> Angriffskraft:
              </span>
              <span class="stat-value">{{ gameState.currentEnemy.attackPower }}</span>
            </div>

            <div class="stat-row" *ngIf="gameState.currentEnemy.weapon">
              <span class="stat-label">
                <i class="bi bi-hammer text-secondary"></i> Waffe:
              </span>
              <span class="stat-value">{{ gameState.currentEnemy.weapon }}</span>
            </div>

            <div class="stat-row" *ngIf="gameState.currentEnemy.hasSpecialAttack">
              <span class="badge bg-warning">
                <i class="bi bi-exclamation-triangle"></i> Hat Spezialangriff
              </span>
            </div>
          </div>

          <div class="status-body text-center text-muted" *ngIf="!gameState.currentEnemy">
            <i class="bi bi-emoji-smile fs-1"></i>
            <p class="mb-0 mt-2">Aktuell kein Gegner</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Row - Inventory Panel (Left) + Chat Panel (Right) -->
  <div class="main-content-row">
    <div class="row g-3">
      <!-- Left: Inventory Panel -->
      <div class="col-lg-3">
        <div class="inventory-panel">
          <!-- Tower Progress -->
          <div class="inventory-card" *ngIf="gameState?.gameSession">
            <div class="inventory-header">
              <i class="bi bi-building"></i> Turmfortschritt
            </div>
            <div class="inventory-body">
              <div class="tower-progress">
                <div class="floor-display">
                  <span class="current-floor">{{ gameState?.gameSession?.currentFloor }}</span>
                  <span class="floor-separator">/</span>
                  <span class="max-floor">{{ gameState?.gameSession?.maxFloor }}</span>
                </div>
                <div class="progress mt-2" style="height: 10px;">
                  <div 
                    class="progress-bar bg-success" 
                    [style.width.%]="getTowerProgress()">
                  </div>
                </div>
                <div class="mt-2">
                  <span class="badge" 
                        [class.bg-success]="gameState?.gameSession?.difficulty === 10"
                        [class.bg-warning]="gameState?.gameSession?.difficulty === 20"
                        [class.bg-danger]="gameState?.gameSession?.difficulty === 30">
                    {{ getDifficultyLabel(gameState?.gameSession?.difficulty) }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Gold Display -->
          <div class="inventory-card" *ngIf="gameState?.character">
            <div class="inventory-header">
              <i class="bi bi-coin"></i> Gold
            </div>
            <div class="inventory-body">
              <div class="gold-display">
                <i class="bi bi-coin text-warning fs-1"></i>
                <span class="gold-amount">{{ gameState?.character?.gold }}</span>
              </div>
            </div>
          </div>

          <!-- Weapons Inventory -->
          <div class="inventory-card" *ngIf="gameState?.character?.weapons && gameState?.character?.weapons.length > 0">
            <div class="inventory-header">
              <i class="bi bi-hammer"></i> Waffen
            </div>
            <div class="inventory-body">
              <div class="weapons-list">
                <div 
                  *ngFor="let weapon of gameState?.character?.weapons" 
                  class="weapon-item"
                  [class.equipped]="weapon.isEquipped">
                  <div class="weapon-header">
                    <strong>{{ weapon.name }}</strong>
                    <span class="badge bg-success" *ngIf="weapon.isEquipped">Ausger√ºstet</span>
                  </div>
                  <div class="weapon-details">
                    <span class="badge bg-secondary">{{ weapon.type }}</span>
                    <span class="badge bg-danger">
                      <i class="bi bi-lightning-fill"></i> {{ weapon.totalDamage }}
                    </span>
                    <span class="badge bg-primary" *ngIf="weapon.upgradeLevel > 0">
                      +{{ weapon.upgradeLevel }}
                    </span>
                  </div>
                  <div class="weapon-meta">
                    <small>Verkaufswert: {{ weapon.sellValue }} Gold</small>
                    <small *ngIf="weapon.upgradeCost">Upgrade: {{ weapon.upgradeCost }} Gold</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions 
          <div class="inventory-card">
            <div class="inventory-header">
              <i class="bi bi-joystick"></i> Schnellaktionen
            </div>
            <div class="inventory-body">
              <div class="quick-actions">
                <button 
                  class="btn btn-sm btn-outline-primary w-100 mb-2"
                  (click)="useQuickAction('Zeige mir meinen Status')"
                  [disabled]="isLoading">
                  <i class="bi bi-person-badge"></i> Status
                </button>
                <button 
                  class="btn btn-sm btn-outline-success w-100 mb-2"
                  (click)="useQuickAction('Ich gehe zum n√§chsten Stockwerk')"
                  [disabled]="isLoading">
                  <i class="bi bi-arrow-up-circle"></i> N√§chstes Stockwerk
                </button>
                <button 
                  class="btn btn-sm btn-outline-info w-100 mb-2"
                  (click)="useQuickAction('Zeige mir mein Inventar')"
                  [disabled]="isLoading">
                  <i class="bi bi-bag"></i> Inventar
                </button>
                <button 
                  class="btn btn-sm btn-outline-warning w-100"
                  (click)="useQuickAction('Ich m√∂chte heilen')"
                  [disabled]="isLoading">
                  <i class="bi bi-heart-pulse"></i> Heilen
                </button>
              </div>
            </div>
          </div>-->

          <!-- New Game Button -->
          <div class="text-center mt-3">
            <button 
              class="btn btn-danger w-100"
              (click)="startNewGame()">
              <i class="bi bi-arrow-clockwise"></i> Neues Spiel starten
            </button>
          </div>
        </div>
      </div>

      <!-- Right: Chat Panel -->
      <div class="col-lg-9">
        <div class="chat-panel">
          <!-- Chat Header -->
          <div class="chat-header">
            <h4 class="mb-0">
              <i></i> Der Pfad zum Turm
            </h4>
          </div>

          <!-- Chat Messages -->
          <div class="chat-messages" #chatMessages>
            <div 
              *ngFor="let msg of conversationHistory" 
              class="message-wrapper"
              [class.user-message]="msg.role === 'user'"
              [class.ai-message]="msg.role === 'assistant'">
              <div class="message-bubble">
                <div class="message-role">
                  <i class="bi" [class.bi-person-fill]="msg.role === 'user'" 
                               [class.bi-robot]="msg.role === 'assistant'"></i>
                  {{ msg.role === 'user' ? 'Du' : 'Zorro' }}
                </div>
                <div class="message-content" [innerHTML]="msg.content | lineBreaks"></div>
              </div>
            </div>

            <!-- Loading Indicator -->
            <div class="message-wrapper ai-message" *ngIf="isLoading">
              <div class="message-bubble">
                <div class="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Input -->
          <div class="chat-input-container">
            <div class="input-group">
              <input 
                type="text" 
                class="form-control chat-input" 
                [(ngModel)]="currentMessage"
                (keyup.enter)="sendMessage()"
                [disabled]="isLoading"
                placeholder="Schreibe deine Nachricht an den KI Spielmeister...">
              <button 
                class="btn btn-primary" 
                (click)="sendMessage()"
                [disabled]="isLoading || !currentMessage.trim()">
                <i class="bi bi-send-fill"></i> Senden
              </button>
            </div>
            <small class="text-muted mt-2 d-block">
              üí° Tipp: Schreibe nat√ºrliche S√§tze wie "Ich greife den Troll an" oder "Zeige mir meinen Status"
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
